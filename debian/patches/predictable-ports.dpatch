#! /bin/sh /usr/share/dpatch/dpatch-run
## predictable-ports.dpatch by  <fw@deneb.enyo.de>
##
## All lines beginning with `## DP:' are a description of the patch.
## DP: No description.

@DPATCH@
diff -urNad git~/dns_random.cc git/dns_random.cc
--- git~/dns_random.cc	2008-07-11 23:09:08.000000000 +0200
+++ git/dns_random.cc	2008-07-11 23:09:40.000000000 +0200
@@ -23,8 +23,7 @@
   memcpy(g_counter, &now.tv_usec, sizeof(now.tv_usec));
   memcpy(g_counter+sizeof(now.tv_usec), &now.tv_sec, sizeof(now.tv_sec));
   g_in = getpid() | (getppid()<<16);
-
-  srandom(now.tv_usec);
+  srandom(dns_random(numeric_limits<uint32_t>::max()));
 }
 
 static void counterIncrement(unsigned char* counter)
diff -urNad git~/pdns_recursor.cc git/pdns_recursor.cc
--- git~/pdns_recursor.cc	2008-07-11 23:09:08.000000000 +0200
+++ git/pdns_recursor.cc	2008-07-11 23:09:08.000000000 +0200
@@ -202,7 +202,7 @@
 
   int tries=10;
   while(--tries) {
-    uint16_t port=1025+Utility::random()%64510;
+    uint16_t port=1025+dns_random(64510);
     if(tries==1)  // fall back to kernel 'random'
 	port=0;
 
